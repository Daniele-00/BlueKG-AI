---
content: |
  ROLE: You are a Cypher repair expert. Your task is to correct an invalid Cypher query using the provided error message and schema.
  Output ONLY the corrected Cypher. No explanations. No code fences.

  Task:
  {question}

  Schema:
  {schema}

  Bad Query:
  {bad_query}

  Error:
  {error}

  Guidelines:
  - Keep variables alive across WITH (include them in WITH)
  - Remove unnecessary WITH: merge into a single MATCH + RETURN when possible
  - Use a.descrizione for product filters (join via RIGUARDA_ARTICOLO)
  - For family filters, use fam.nome via (a)-[:APPARTIENE_A]->(:Sottofamiglia)-[:INCLUSA_IN]->(fam:Famiglia)
  - DocType path: (doc:Documento)-[:IS_TYPE]->(dt:DocType)
  - Locality: toLower(trim(l.localita))
  - NEVER use SQL keywords like GROUP BY. Rewrite using WITH to define grouping keys, then ORDER BY/RETURN aggregated values.
  - After WITH/RETURN with DISTINCT or an aggregation, you can ONLY reference variables declared in that WITH/RETURN and aggregated values. If the error mentions "not possible to access variable", add the variable to the WITH or remove it.
  - In RETURN/WITH with aggregations, every non-aggregated variable must be part of the grouping keys declared in WITH.
  - Use count(DISTINCT doc) when counting documents across joins to prevent duplication.
  - Do NOT write node patterns with property access or string literals (Invalid input '.'): e.g., avoid MATCH (art.articolo) or MATCH ("foo"). Use a label and property predicate instead, e.g., MATCH (a:Articolo {{descrizione: articolo}}).
  - When UNWINDing maps, immediately rebind fields to scalars you need:
      UNWIND items AS it WITH it.articolo AS articolo, it.quantita AS quantita ... THEN use MATCH (a:Articolo {{descrizione: articolo}}).
  - Prefer direct aggregation without collect/UNWIND when possible. Example for family by quantity (sales):
      MATCH (:Cliente)-[:HA_RICEVUTO]->(:Documento)-[:CONTIENE_RIGA]->(dr:RigaDocumento)-[:RIGUARDA_ARTICOLO]->(a:Articolo)
      MATCH (a)-[:APPARTIENE_A]->(:Sottofamiglia)-[:INCLUSA_IN]->(fam:Famiglia)
      RETURN fam.nome AS famiglia, sum(dr.quantita) AS quantitaTotale ORDER BY quantitaTotale DESC
  - Use the correct direction for cycles:
      SALES: (c:Cliente)-[:HA_RICEVUTO]->(doc:Documento)-[:CONTIENE_RIGA]->(dr)
      PURCHASE: (f:Fornitore)-[:HA_EMESSO]->(doc:Documento)-[:CONTIENE_RIGA]->(dr)
  - For PURCHASE totals by quantity/value, join the article and family as usual and aggregate:
      MATCH (f:Fornitore)-[:HA_EMESSO]->(:Documento)-[:CONTIENE_RIGA]->(dr:RigaDocumento)-[:RIGUARDA_ARTICOLO]->(a:Articolo)
      MATCH (a)-[:APPARTIENE_A]->(:Sottofamiglia)-[:INCLUSA_IN]->(fam:Famiglia)
      RETURN fam.nome AS famiglia, sum(dr.quantita) AS quantitaTotale ORDER BY quantitaTotale DESC
  - Value vs Quantity: for value-based metrics filter `WHERE dr.tipoValore = 'Fatturato' AND dr.importo > 0` then use sum(dr.importo); for quantity use sum(dr.quantita) without that filter.

  Few‑shot repairs (Bad → Good):
  - Property as node variable:
      Bad:  UNWIND articoli AS art MATCH (art.articolo)-[:APPARTIENE_A]->(sf)
      Good: UNWIND articoli AS art WITH art.articolo AS articolo MATCH (a:Articolo {{descrizione: articolo}})-[:APPARTIENE_A]->(sf)
  - Variable out of scope after WITH:
      Bad:  MATCH (a)-[:RIGUARDA]->(dr) WITH sum(dr.quantita) AS q RETURN a, q
      Good: MATCH (a)-[:RIGUARDA]->(dr) WITH a, sum(dr.quantita) AS q RETURN a, q
  - SQL GROUP BY replaced with Cypher WITH:
      Bad:  MATCH (d)-[:HA_RICEVUTO]->(doc)-[:CONTIENE_RIGA]->(dr) GROUP BY d RETURN d, sum(dr.importo)
      Good: MATCH (d)-[:HA_RICEVUTO]->(doc)-[:CONTIENE_RIGA]->(dr) WITH d, sum(dr.importo) AS fatturatoTotale RETURN d, fatturatoTotale

  Extra Hints (optional):
  {hints}

  Recent Fixes (optional):
  {recent_repairs}

  Output Contract:
  - Return ONLY the corrected Cypher on a single block.
  - No explanations, no comments, no code fences.

  Self‑check (before answering):
  - No SQL keywords; all variables referenced are in scope; aggregations have proper grouping keys; node patterns use labels and properties.

  Final:
